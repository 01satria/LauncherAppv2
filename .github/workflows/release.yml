# .github/workflows/release.yml
# Trigger: setiap push tag berbentuk v1.0, v1.2.3, dsb.
name: Build & Release APK

on:
  push:
    tags:
      - 'v*.*'          # contoh: v1.0, v1.0.1, v2.3.0
  workflow_dispatch:    # bisa trigger manual dari GitHub UI

# Izin untuk membuat GitHub Release dan upload asset
permissions:
  contents: write

jobs:
  build:
    name: Build Release APKs
    runs-on: ubuntu-latest

    steps:
      # â”€â”€ 1. Checkout kode â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Checkout repository
        uses: actions/checkout@v4

      # â”€â”€ 2. Setup JDK 17 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'   # OpenJDK Adoptium â€” gratis, stabil
          cache: gradle             # cache ~/.gradle antar run â†’ lebih cepat

      # â”€â”€ 3. Decode keystore dari Secret â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Keystore di-encode base64 lalu disimpan sebagai GitHub Secret
      - name: Decode keystore
        run: |
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 --decode > $GITHUB_WORKSPACE/app/keystore.jks

      # â”€â”€ 4. Beri izin eksekusi ke Gradle wrapper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Grant Gradle execute permission
        run: chmod +x android/gradlew

      # â”€â”€ 5. Build release APK per ABI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Build Release APKs (split ABI)
        run: ./gradlew assembleRelease
        env:
          KEYSTORE_PATH:     ${{ github.workspace }}/app/keystore.jks
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS:         ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD:      ${{ secrets.KEY_PASSWORD }}

      # â”€â”€ 6. Tampilkan APK yang dihasilkan (untuk debug log) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: List generated APKs
        run: find app/build/outputs/apk/release -name "*.apk" | sort

      # â”€â”€ 7. Baca versionName dari build.gradle untuk nama release â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Get version name
        id: version
        run: |
          VERSION=$(grep 'versionName' app/build.gradle.kts | head -1 | sed 's/.*"\(.*\)".*/\1/')
          echo "name=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      # â”€â”€ 8. Buat GitHub Release dan upload semua APK sekaligus â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Create GitHub Release & Upload APKs
        uses: softprops/action-gh-release@v2
        with:
          name: "Satria Launcher v${{ steps.version.outputs.name }}"
          body: |
            ## ðŸ“¦ Satria Launcher v${{ steps.version.outputs.name }}

            ### Download APK yang sesuai device kamu:

            | File | Cocok untuk |
            |---|---|
            | `*-arm64-v8a.apk` | HP Android modern (2017+) â€” **pilih ini kalau ragu** |
            | `*-armeabi-v7a.apk` | HP Android lama 32-bit |
            | `*-x86_64.apk` | Emulator / ChromeOS |

            ### Cara install:
            1. Download APK yang sesuai
            2. Aktifkan "Install from unknown sources" di Settings
            3. Buka file APK â†’ Install
            4. Set sebagai launcher default saat diminta

          files: app/build/outputs/apk/release/*.apk
          draft: false
          prerelease: false
          token: ${{ secrets.GITHUB_TOKEN }}
