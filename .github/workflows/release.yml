name: Build & Release APK

on:
  push:
    tags:
      - 'v*.*'          # e.g. v1.0, v1.1, v2.0 â€” triggers when a new tag starting with 'v' is pushed
  workflow_dispatch:    # can also be triggered manually from GitHub UI

# Permission to create GitHub Releases and upload assets
permissions:
  contents: write

jobs:
  build:
    name: Build Release APKs
    runs-on: ubuntu-latest

    steps:
      # â”€â”€ 1. Checkout code â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Checkout repository
        uses: actions/checkout@v4

      # â”€â”€ 2. Setup JDK 17 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'   # OpenJDK Adoptium â€” free and stable
          cache: gradle             # cache ~/.gradle between runs â†’ faster builds

      # â”€â”€ 3. Decode keystore from Secret â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Keystore is base64-encoded and stored as a GitHub Secret
      - name: Decode keystore
        run: |
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 --decode > $GITHUB_WORKSPACE/app/keystore.jks

      # â”€â”€ 4. Grant execute permission to Gradle wrapper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Grant Gradle execute permission
        run: chmod +x gradlew

      # â”€â”€ 5. Build release APK per ABI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Build Release APKs (split ABI)
        run: ./gradlew assembleRelease
        env:
          KEYSTORE_PATH:     ${{ github.workspace }}/app/keystore.jks
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS:         ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD:      ${{ secrets.KEY_PASSWORD }}

      # â”€â”€ 6. List generated APKs (for debug log) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: List generated APKs
        run: find app/build/outputs/apk/release -name "*.apk" | sort

      # â”€â”€ 7. Read versionName from build.gradle for release name â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Get version name
        id: version
        run: |
          VERSION=$(grep 'versionName' app/build.gradle.kts | head -1 | sed 's/.*"\(.*\)".*/\1/')
          echo "name=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      # â”€â”€ 8. Create GitHub Release and upload all APKs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Create GitHub Release & Upload APKs
        uses: softprops/action-gh-release@v2
        with:
          name: "Satria Launcher v${{ steps.version.outputs.name }}"
          body: |
            ## ğŸ“¦ Satria Launcher v${{ steps.version.outputs.name }}

            ### Download the APK for your device:

            | File | For |
            |---|---|
            | `*-arm64-v8a.apk` | Modern Android phones (2017+) â€” **pick this if unsure** |
            | `*-armeabi-v7a.apk` | Older 32-bit Android phones |
            | `*-x86_64.apk` | Emulators / ChromeOS |

            ### How to install:
            1. Download the right APK for your device
            2. Enable **Install from unknown sources** in Settings
            3. Open the APK file and tap Install
            4. Set as your default launcher when prompted

            ### âš ï¸ Google Play Protect warning?
            Google Play Protect may flag this APK as unrecognized since it's not distributed through the Play Store. **This app is safe.** Here's what to do:
            1. When the warning appears, tap **More details**
            2. Tap **Install anyway** or tap **Scan app** first if you'd like to verify it yourself
            3. The app will install normally

          files: app/build/outputs/apk/release/*.apk
          draft: false
          prerelease: false
          token: ${{ secrets.GITHUB_TOKEN }}